# VoiceForce 音声操作リファレンス

> **使い方**: `Option+V`（Mac）を押しながら発話 → 離す
> Salesforce のページ上でのみ動作します。

---

## 目次

1. [一覧ページへ移動する](#1-一覧ページへ移動する)
2. [レコードを検索する](#2-レコードを検索する)
3. [画面操作コマンド](#3-画面操作コマンド)
4. [対応オブジェクト一覧](#4-対応オブジェクト一覧)
5. [処理の仕組み（技術メモ）](#5-処理の仕組み技術メモ)
6. [未実装機能（今後対応予定）](#6-未実装機能今後対応予定)

---

## 1. 一覧ページへ移動する

> **処理**: ruleEngine（正規表現）で即座に実行します。LLM は使いません。

### 基本の一覧

| 発話例 | 動作 |
|---|---|
| 「商談」 | 商談の一覧を開く |
| 「商談一覧を開いて」 | 商談の一覧を開く |
| 「商談の一覧を表示してください」 | 商談の一覧を開く |
| 「商談を開いて」「商談出して」「商談見せて」 | 商談の一覧を開く |
| 「取引先一覧」「リード一覧を開いて」 | 各オブジェクトの一覧を開く |

**対応する言い回し（動詞）**: 開いて / 出して / 見せて / 表示して / 表示 / 開く / 開け

### フィルター指定

| 発話例 | フィルター |
|---|---|
| 「すべての商談を開いて」 | すべての商談（All） |
| 「全ての商談を開いて」「全部の商談」 | すべての商談（All） |
| 「商談のすべてを開いて」 | すべての商談（All） |
| 「最近参照した商談を開いて」 | 最近参照した商談（RecentlyViewed） |
| 「最近の商談を開いて」「最近見た商談」 | 最近参照した商談（RecentlyViewed） |
| 「自分の商談を開いて」 | 私の商談（MyOpportunities） |
| 「私の商談一覧」「自分の商談一覧を開いて」 | 私の商談（MyOpportunities） |

### 誤認識への対応

| 実際の発話 | Google が認識する言葉 | 動作 |
|---|---|---|
| 「商談一覧」 | 「相談一覧」と認識されても | 正しく商談一覧を開く ✓ |

---

## 2. レコードを検索する

> **処理**: ruleEngine（正規表現）でキーワードを抽出し、SOSL（曖昧検索）で Salesforce に問い合わせます。
> 結果はすべてウィジェット内で完結します（外部ページへの遷移はありません）。

### 対応している発話パターン

| 発話形式 | 発話例 | 動作 |
|---|---|---|
| `[キーワード]の[オブジェクト]を開いて` | 「田中商事の商談を開いて」 | 「田中商事」で検索 |
| `[キーワード]の[オブジェクト]を見せて` | 「山田太郎の取引先責任者を見せて」 | 「山田太郎」で検索 |
| `[オブジェクト]の[キーワード]を表示して` | 「取引先のABC株式会社を表示して」 | 「ABC株式会社」で検索 |
| `[オブジェクト]で[キーワード]を検索して` | 「商談で田中を検索して」 | 「田中」で検索 |
| `[キーワード]を表示して` | 「ABC株式会社を表示して」 | 「ABC株式会社」で検索 |
| `[キーワード]を見せて` | 「田中商事を見せて」 | 「田中商事」で検索 |

### 検索結果に応じた動作

| ヒット件数 | 動作 |
|---|---|
| **1件** | そのレコードを直接開く |
| **2〜5件** | ウィジェットに候補リストを表示 → 番号を言うか候補をクリックして選択 |
| **6件以上** | 「絞り込んでください」とウィジェットに表示（約4秒後に消える） |
| **0件（初回）** | EDITING 状態に遷移：入力欄にキーワードを表示、手動修正して再検索できる |
| **0件（再検索後）** | 「検索不一致：〜は見つかりませんでした」とウィジェットに表示（約3秒後に消える） |

> **曖昧検索（soslFuzzy）**: 以下の順で自動的に複数バリアントを試みます。
> - **フェーズ1**: 法人格除去（「株式会社」「かぶしきがいしゃ」など）・ひらがな↔カタカナ変換
> - **フェーズ2**: 4文字以上のキーワードに対し末尾ワイルドカード（`keyword*`）で前方一致検索
>   （末尾1〜2文字の欠けや表記ゆれに対応）

### 候補リストが表示されたとき（2〜5件ヒット）

ウィジェットの上に番号付き候補リストが表示されます。

| 操作 | 動作 |
|---|---|
| `Option+V` → 「1番」と発話 | 1番のレコードを開く |
| `Option+V` → 「2」と発話 | 2番のレコードを開く |
| 候補をクリック | そのレコードを開く |

---

## 3. 画面操作コマンド

> **処理**: ruleEngine（正規表現）で即座に実行します。LLM は使いません。

### ナビゲーション

| 発話 | 動作 |
|---|---|
| 「戻って」「戻る」「バック」「前の画面」「前に戻って」 | ブラウザの「戻る」（history.back） |

---

## 4. 対応オブジェクト一覧

| 発話 | Salesforce オブジェクト |
|---|---|
| 商談 | Opportunity |
| 取引先 | Account |
| 取引先責任者 | Contact |
| リード | Lead |
| タスク / ToDo | Task |
| 行動 | Event |

> **誤認識対応**: 「相談」と認識された場合も「商談（Opportunity）」として処理します。

---

## 5. 処理の仕組み（技術メモ）

### 現在の処理フロー

```
発話テキスト
    │
    ▼
┌─────────────────────────────────────────┐
│ ruleEngine（正規表現）                   │
│  - 一覧ナビゲーション                    │
│  - レコード検索（パターン限定）           │
│  - 戻る / 候補選択                       │
└────────────────────┬────────────────────┘
                     │ マッチした → 実行
                     │ マッチしない → 「認識: [発話]」と表示（何も起きない）
```

> **注**: LLM（Claude Haiku）による意図解析は `lib/intentResolver.js` と `worker/index.js`
> に実装済みですが、`content.js` からの呼び出しが未接続のため現在は機能しません。

### 利用制限

- ruleEngine で処理されるコマンドは**制限なし**
- LLM を使う操作は現時点では未対応（接続後は 1日あたり **10回** を予定）

### プライバシー

- Salesforce の顧客データは外部サーバーを**一切経由しない**
- 送信されるのは「発話テキスト」と「Salesforce オブジェクト定義（メタデータ）」のみ
- アクセストークンは AES-256-GCM で端末内に暗号化保存

---

## 6. 未実装機能（今後対応予定）

以下の機能は**現在動作しません**。発話しても「認識: [発話内容]」と表示されるだけです。

### LLM フォールバック未接続により未対応

| 機能 | 発話例 | 状態 |
|------|-------|------|
| レコード作成 | 「山田商事の商談を作って」 | 未実装 |
| レコード更新 | 「この商談のフェーズを提案中に変えて」 | 未実装 |
| 情報の集計・要約 | 「今月のパイプラインを教えて」 | 未実装 |
| 柔軟な検索 | 「先週作った取引先を探して」 | 未実装 |

### content.js への処理実装が必要

| 機能 | 発話例 | 状態 |
|------|-------|------|
| 停止 | 「止めて」「停止」「ストップ」 | ruleEngine は認識するが何も起きない |
| 元に戻す（undo） | 「元に戻して」「取り消して」 | ruleEngine は認識するが何も起きない |
| 確認応答 | 「はい」「いいえ」 | 確認ダイアログ自体が未実装のため機能なし |
| ヘルプ | 「ヘルプ」「使い方」 | ruleEngine は認識するが何も起きない |

---

*最終更新: 2026-02-27*
*関連: `lib/ruleEngine.js` / `content.js` / `lib/intentResolver.js` / `worker/index.js`*
